[//]: # (Image References)

[prefView]: ./pic/ArduinoPref.png "Preferences view"
[toolsView]: ./pic/ArduinoTools.png "Tools view"
[tlView]: ./pic/TrafficLight.png "Traffic Light"
[lgView]: ./pic/LaserGate.jpg "Laser Gate"
[cityInt]: ./pic/CityInterface.png "City Interface"
[speedInt]: ./pic/SpeedInterface.png "Speed Interface"


# **TrafficLights**
---

Это репозиторий для прошивок светофоров [Makely Traffic Light v2](makely.ru/traffic-light) ![tlView]

и лазерных ворот [Makely Laser Gate v2](makely.ru/laser-gate). ![lgView]


## Структура папок
---
/OTA-Alone - Ардуино прошивка для независимой работы **одного** светофора.

/OTA-Light - Ардуино прошивка для групповой работы стартовых светофоров и двух светофоров на одном направлении перекрестка.

/OTA-Light_inverse - аналогична предыдущей, только для двух инверсных светофоров на поперечном направлении перекрестка.

/OTA-LaserGates - Ардуино прошивка для лазерных ворот по регламенту Роботраффика в категории "Скорость".

/OTA-Stop - Ардуино прошивка для независимой работы стоп сигнала, или сигнала пешеходного перехода (задается константой stageCmds).

/ESC-calib - прошивка для Ардуино на машинке для калибровки ШИМ-драйвера мотора через ввод команд в последовательный порт Ардуины с ПК.

/DesktopServer - Серверные приложения для ПК на Windows/macOS/Linux Python3 для управления светофорами и лазерными воротами в категориях "Город" (city.py) и "Скорость" (speed.py).

## Программирование светофоров и лазерных ворот
---
#### Подготовка

Для программирования возможно понадобится установить драйвера USB-UART интерфейса отсюда: https://www.silabs.com/products/development-tools/software/usb-to-uart-bridge-vcp-drivers

Arduino IDE должна быть не менее 1.6.4 (лучше скачать последнюю (1.8.5 на данный момент) с официального сайта Arduino). В ней заходите в настройки и прописываете ссылку на репозиторий поддержки дополнительных плат (Additional Board Manager URLs): http://arduino.esp8266.com/stable/package_esp8266com_index.json
Затем заходите в менеджер дополнительных плат, находите там esp8266 и устанавливаете последнюю версию.
![prefView]

Все, теперь выбираете из списка плат "NodeMCU 1.0 (ESP-12E Module)", нужный последовательный порт и проверяете остальные параметры, чтобы были как на следующей картинке.
![toolsView]

#### Программирование

Открываете нужную прошивку для светофора из репозитория - файл \*.ino. Откроется среда ArduinoIDE, если все правильно настроили на предыдущем щаге, остается заменить имя и пароль беспроводной среды (переменные **ssid** и **password**) и нажать на кнопку "загрузить скетч".

## Использование
---
Предполагается, что светофоры запрограммированы на совместную работу прошивками OTA-Light и OTA-Light_inverse. Компьютер подключен к той же Wi-Fi сети, которая указана в прошивке светофоров, или находится в одной локальной сети (при подключении компьютера к маршрутизатору через Ethernet кабель).

Включить все оборудование на поле (соревнования в разных категориях проводить поочередно), подождать около 30 секунд, пока на светофорах загорится красный свет - значит Wi-Fi подключение установлено.

В папке DesktopServer запускаете city.exe для категории "Город" (таймер по регламенту настроен на обратный отсчет 4 минут)

![cityInt]

или speed.exe для категории "Скорость".

![speedInt]

Нажать кнопку "START" для старта заезда.

"STOP" — для остановки заезда и таймера.

"RESET" - для остановки заезда со сбросом таймера в начальное значение.

## Возможные проблемы
---
### При включении

Если светофор горит ровным желтым - значит ему требуется зарядка.

Если мигает желтым - идет подключение к Wi-Fi сети.

### При работе сценария

Визуально проверять включение всех светофоров при старте заезда и выключение при окончании. Потеря сигнала маловероятна, но возможна из-за помех и наличии препятствий на пути сигнала. Поэтому рекомендуем размещать Wi-Fi точку доступа на краю поля и подключать ноутбук к маршрутизатору по проводу.
